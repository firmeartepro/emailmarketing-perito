<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Email Marketing - Mois√©s Perito</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1.1em;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #2c3e50;
            border-bottom: 3px solid #667eea;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #2c3e50;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border-left: 5px solid #667eea;
        }

        .stat-card h3 {
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #6c757d;
            font-weight: 600;
        }

        .email-template {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 5px solid #28a745;
        }

        .template-preview {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #dee2e6;
        }

        .contact-list {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .contact-item {
            padding: 15px;
            border-bottom: 1px solid #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contact-item:last-child {
            border-bottom: none;
        }

        .contact-item:hover {
            background: #f8f9fa;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .tab-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìß Sistema de Email Marketing</h1>
            <p>Ferramenta Profissional para Mois√©s - Perito Grafot√©cnico</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('contacts')">üë• Contatos</button>
            <button class="tab" onclick="showTab('templates')">üé® Templates</button>
            <button class="tab" onclick="showTab('campaigns')">üì§ Campanhas</button>
            <button class="tab" onclick="showTab('settings')">‚öôÔ∏è Configura√ß√µes</button>
        </div>

        <!-- Dashboard -->
        <div class="tab-content active" id="dashboard">
            <h2>üìä Dashboard - Vis√£o Geral</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalContacts">0</h3>
                    <p>üë• Total de Contatos</p>
                </div>
                <div class="stat-card">
                    <h3 id="sentThisMonth">0</h3>
                    <p>üìß Emails Enviados (M√™s)</p>
                </div>
                <div class="stat-card">
                    <h3 id="templatesCount">2</h3>
                    <p>üé® Templates Dispon√≠veis</p>
                </div>
                <div class="stat-card">
                    <h3 id="campaignsCount">0</h3>
                    <p>üì§ Campanhas Ativas</p>
                </div>
            </div>

            <div class="alert alert-success">
                <strong>‚úÖ Sistema Operacional!</strong> Tudo funcionando perfeitamente. Pronto para enviar campanhas profissionais.
            </div>

            <div class="form-group">
                <button class="btn btn-success" onclick="testEmailSystem()">üß™ Testar Sistema de Email</button>
                <button class="btn btn-warning" onclick="showTab('settings')">‚öôÔ∏è Configurar EmailJS</button>
            </div>
        </div>

        <!-- Contatos -->
        <div class="tab-content" id="contacts">
            <h2>üë• Gerenciar Contatos</h2>
            
            <div class="form-group">
                <label for="contactName">Nome do Contato</label>
                <input type="text" id="contactName" placeholder="Ex: Jo√£o Silva">
            </div>
            
            <div class="form-group">
                <label for="contactEmail">Email</label>
                <input type="email" id="contactEmail" placeholder="Ex: joao@email.com">
            </div>
            
            <div class="form-group">
                <label for="contactCategory">Categoria</label>
                <select id="contactCategory">
                    <option value="cliente">Cliente</option>
                    <option value="prospect">Prospect</option>
                    <option value="parceiro">Parceiro</option>
                    <option value="advogado">Advogado</option>
                </select>
            </div>
            
            <button class="btn btn-success" onclick="addContact()">‚ûï Adicionar Contato</button>
            <button class="btn btn-warning" onclick="importContacts()">üì• Importar Lista</button>
            
            <h3 style="margin-top: 30px;">üìã Lista de Contatos</h3>
            <div class="contact-list" id="contactList">
                <div class="contact-item">
                    <div>
                        <strong>Exemplo - Jo√£o Silva</strong><br>
                        <small>joao@email.com | Cliente</small>
                    </div>
                    <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.9em;">üóëÔ∏è</button>
                </div>
            </div>
        </div>

        <!-- Templates -->
        <div class="tab-content" id="templates">
            <h2>üé® Templates de Email</h2>
            
            <div class="form-group">
                <button class="btn btn-success" onclick="createNewTemplate()">‚ûï Criar Novo Template</button>
                <button class="btn" onclick="generateAITemplate()">ü§ñ Gerar Template com IA</button>
            </div>
            
            <div id="templatesList">
                <div class="email-template" data-template-id="template1">
                    <h3>üìã Template: Consultoria Gratuita - Mois√©s</h3>
                    <div class="template-preview" id="template1">
                        <strong>Assunto:</strong> üîç Descubra se Seus Documentos S√£o Aut√™nticos - An√°lise GRATUITA com Mois√©s!
                        <br><br>
                        <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 25px; border-radius: 12px; border: 2px solid #2196f3;">
                            <p><strong>Ol√° [NOME],</strong></p>
                            <p>Sou <strong>Mois√©s, Perito Grafot√©cnico</strong>, e voc√™ sabia que <strong>73% dos documentos questionados</strong> apresentam algum tipo de irregularidade?</p>
                            <p>Como especialista em Grafoscopia, posso ajudar voc√™ a descobrir a verdade sobre qualquer documento suspeito.</p>
                            <p><strong>üéÅ OFERTA ESPECIAL:</strong> An√°lise grafot√©cnica GRATUITA para novos clientes!</p>
                            <div style="text-align: center; margin: 25px 0;">
                                <a href="https://firmeartepro.blogspot.com/p/sistema-de-consultoria-em-grafoscopia.html" target="_blank" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 25px; font-weight: bold; margin: 10px; display: inline-block;">
                                    ü§ñ AN√ÅLISE GRATUITA COM IA
                                </a>
                                <br>
                                <a href="https://firmeartepro.blogspot.com/p/moises-firme-perito-assistente-tecnico.html" target="_blank" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 25px; font-weight: bold; margin: 10px; display: inline-block;">
                                    üìö SAIBA MAIS SOBRE MOIS√âS
                                </a>
                            </div>
                            <p><strong>Contato direto:</strong><br>
                            üìß moises.peritografotecnico@gmail.com</p>
                            <p><small>Esta oferta √© v√°lida apenas por tempo limitado!</small></p>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="deleteTemplate('template1')" style="margin-top: 10px;">üóëÔ∏è Excluir</button>
                </div>
                
                <div class="email-template" data-template-id="template2">
                    <h3>üíº Template: Contrata√ß√£o Profissional - Mois√©s</h3>
                    <div class="template-preview" id="template2">
                        <strong>Assunto:</strong> ‚öñÔ∏è Precisa de Per√≠cia Grafot√©cnica Oficial? Perito Mois√©s Dispon√≠vel
                        <br><br>
                        <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 25px; border-radius: 12px; border: 2px solid #9c27b0;">
                            <p><strong>Prezado(a) [NOME],</strong></p>
                            <p>Quando a <strong>autenticidade de documentos</strong> est√° em quest√£o, voc√™ precisa de um especialista confi√°vel.</p>
                            <p><strong>Mois√©s - Perito Grafot√©cnico:</strong><br>
                            ‚úÖ Perito Assistente T√©cnico Certificado<br>
                            ‚úÖ Laudos aceitos em tribunais<br>
                            ‚úÖ Mais de 500 casos analisados<br>
                            ‚úÖ Relat√≥rios t√©cnicos detalhados</p>
                            <div style="text-align: center; margin: 25px 0;">
                                <a href="https://firmeartepro.blogspot.com/p/sistema-de-consultoria-em-grafoscopia.html" target="_blank" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 25px; font-weight: bold; margin: 10px; display: inline-block;">
                                    ü§ñ AN√ÅLISE GRATUITA COM IA
                                </a>
                                <br>
                                <a href="https://firmeartepro.blogspot.com/p/moises-firme-perito-assistente-tecnico.html" target="_blank" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 25px; font-weight: bold; margin: 10px; display: inline-block;">
                                    üìö SAIBA MAIS SOBRE MOIS√âS
                                </a>
                            </div>
                            <p><strong>Contato:</strong> moises.peritografotecnico@gmail.com</p>
                            <p><strong>Urg√™ncia?</strong> Atendimento em 24h para casos emergenciais.</p>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="deleteTemplate('template2')" style="margin-top: 10px;">üóëÔ∏è Excluir</button>
                </div>
            </div>
        </div>

        <!-- Campanhas -->
        <div class="tab-content" id="campaigns">
            <h2>üì§ Criar e Enviar Campanhas</h2>
            
            <div class="form-group">
                <label for="campaignName">Nome da Campanha</label>
                <input type="text" id="campaignName" placeholder="Ex: Promo√ß√£o An√°lise Gratuita - Janeiro 2024">
            </div>
            
            <div class="form-group">
                <label for="campaignMode">Modo de Envio</label>
                <select id="campaignMode" onchange="toggleCampaignMode()">
                    <option value="single">Template √önico</option>
                    <option value="rotation">Rota√ß√£o de Templates</option>
                </select>
            </div>
            
            <div class="form-group" id="singleTemplateGroup">
                <label for="campaignTemplate">Selecionar Template</label>
                <select id="campaignTemplate">
                    <option value="template1">üìã Consultoria Gratuita - Mois√©s</option>
                    <option value="template2">üíº Contrata√ß√£o Profissional - Mois√©s</option>
                </select>
            </div>
            
            <div class="form-group" id="rotationTemplateGroup" style="display: none;">
                <label>Selecionar Templates para Rota√ß√£o</label>
                <div id="templateCheckboxes" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;">
                    <label style="display: block; margin-bottom: 10px;">
                        <input type="checkbox" value="template1" checked> üìã Consultoria Gratuita - Mois√©s
                    </label>
                    <label style="display: block; margin-bottom: 10px;">
                        <input type="checkbox" value="template2" checked> üíº Contrata√ß√£o Profissional - Mois√©s
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="campaignAudience">P√∫blico-Alvo</label>
                <select id="campaignAudience">
                    <option value="all">Todos os Contatos</option>
                    <option value="cliente">Apenas Clientes</option>
                    <option value="prospect">Apenas Prospects</option>
                    <option value="parceiro">Apenas Parceiros</option>
                    <option value="advogado">Apenas Advogados</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="sendInterval">Intervalo entre Envios</label>
                <select id="sendInterval">
                    <option value="0">Envio Imediato (sem intervalo)</option>
                    <option value="10080">1 semana</option>
                    <option value="21600">15 dias</option>
                    <option value="43200">1 m√™s (30 dias)</option>
                </select>
            </div>
            
            <div class="form-group">
                <button class="btn btn-success" onclick="sendCampaign()">üöÄ Enviar Campanha Agora</button>
                <button class="btn btn-warning" onclick="scheduleCampaign()">‚è∞ Agendar Envio</button>
                <button class="btn" onclick="previewCampaign()">üëÅÔ∏è Visualizar</button>
            </div>
            
            <div class="loading" id="campaignLoading">
                <div class="loading-spinner"></div>
                <p>Enviando campanha... Por favor, aguarde.</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="campaignProgress"></div>
                </div>
                <p id="campaignStatus">Preparando envio...</p>
            </div>
        </div>

        <!-- Configura√ß√µes -->
        <div class="tab-content" id="settings">
            <h2>‚öôÔ∏è Configura√ß√µes do Sistema</h2>
            
            <div class="alert alert-warning">
                <strong>üîß Configura√ß√£o Necess√°ria:</strong> Para enviar emails reais, configure suas credenciais do EmailJS abaixo.
            </div>
            
            <div class="form-group">
                <label for="emailjsUserId">EmailJS User ID</label>
                <input type="text" id="emailjsUserId" placeholder="Seu User ID do EmailJS">
            </div>
            
            <div class="form-group">
                <label for="emailjsServiceId">Service ID</label>
                <input type="text" id="emailjsServiceId" placeholder="Seu Service ID">
            </div>
            
            <div class="form-group">
                <label for="emailjsTemplateId">Template ID</label>
                <input type="text" id="emailjsTemplateId" placeholder="Seu Template ID">
            </div>
            
            <div class="form-group">
                <label for="senderName">Nome do Remetente</label>
                <input type="text" id="senderName" placeholder="Mois√©s - Perito Grafot√©cnico" value="Mois√©s - Perito Grafot√©cnico">
            </div>
            
            <div class="form-group">
                <label for="monthlyLimit">Limite Mensal de Emails</label>
                <input type="number" id="monthlyLimit" placeholder="200" value="200">
            </div>
            
            <h3 style="margin-top: 30px; color: #2c3e50;">ü§ñ Configura√ß√µes da IA (Gemini)</h3>
            
            <div class="form-group">
                <label for="geminiApiKey">Chave da API do Gemini</label>
                <input type="password" id="geminiApiKey" placeholder="Sua API Key do Google Gemini (AIza...)">
                <small style="color: #6c757d;">
                    <strong>üìç Como obter:</strong><br>
                    1. Acesse: <a href="https://makersuite.google.com/app/apikey" target="_blank">https://makersuite.google.com/app/apikey</a><br>
                    2. Fa√ßa login com sua conta Google<br>
                    3. Clique em "Create API Key"<br>
                    4. Copie a chave (deve come√ßar com "AIza")<br>
                    5. Cole aqui e salve<br>
                    <strong>‚ö†Ô∏è Importante:</strong> Aguarde 5-10 minutos ap√≥s gerar para ativar
                </small>
            </div>
            
            <button class="btn btn-success" onclick="saveEmailJSConfig()">üíæ Salvar Configura√ß√µes</button>
            <button class="btn btn-warning" onclick="testEmailSystem()">üß™ Testar Configura√ß√£o</button>
            <button class="btn" onclick="testGeminiAPI()">ü§ñ Testar IA</button>
            
            <div style="margin-top: 30px;">
                <h3>üìä Status do Sistema</h3>
                <div class="stat-card">
                    <p><strong>Status EmailJS:</strong> <span id="emailjsStatus">‚ùå N√£o Configurado</span></p>
                    <p><strong>Emails Restantes:</strong> <span id="emailsRemaining">0</span></p>
                    <p><strong>√öltimo Teste:</strong> <span id="lastTest">Nunca</span></p>
                </div>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <p>Processando... Por favor, aguarde.</p>
    </div>

    <script>
        // Configura√ß√µes globais
        let emailjsConfig = {
            isConfigured: false,
            userId: '',
            serviceId: '',
            templateId: '',
            senderName: 'Mois√©s - Perito Grafot√©cnico',
            monthlyLimit: 200,
            sentThisMonth: 0,
            geminiApiKey: ''
        };

        let contacts = [
            {
                id: 1,
                name: 'Jo√£o Silva',
                email: 'joao@email.com',
                category: 'cliente'
            }
        ];

        let campaigns = [];
        
        let templates = [
            {
                id: 'template1',
                name: 'Consultoria Gratuita - Mois√©s',
                subject: 'üîç Descubra se Seus Documentos S√£o Aut√™nticos - An√°lise GRATUITA com Mois√©s!',
                isDefault: true
            },
            {
                id: 'template2',
                name: 'Contrata√ß√£o Profissional - Mois√©s',
                subject: '‚öñÔ∏è Precisa de Per√≠cia Grafot√©cnica Oficial? Perito Mois√©s Dispon√≠vel',
                isDefault: true
            }
        ];

        // Inicializar sistema
        document.addEventListener('DOMContentLoaded', function() {
            loadEmailJSConfig();
            updateDashboard();
            updateContactList();
            updateCampaignTemplateOptions();
        });

        // Gerenciamento de abas
        function showTab(tabName) {
            // Esconder todas as abas
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Mostrar aba selecionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Fun√ß√£o para converter HTML em texto limpo e formatado
        function htmlToCleanText(html) {
            // Criar elemento tempor√°rio para processar HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // Substituir tags HTML por formata√ß√£o de texto
            let text = html;
            
            // Quebras de linha
            text = text.replace(/<br\s*\/?>/gi, '\n');
            text = text.replace(/<\/p>/gi, '\n\n');
            text = text.replace(/<p[^>]*>/gi, '');
            
            // Texto em negrito
            text = text.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**');
            text = text.replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**');
            
            // Links
            text = text.replace(/<a[^>]*href="([^"]*)"[^>]*>(.*?)<\/a>/gi, '$2 ($1)');
            
            // Remover divs e spans mantendo conte√∫do
            text = text.replace(/<\/?div[^>]*>/gi, '\n');
            text = text.replace(/<\/?span[^>]*>/gi, '');
            
            // Remover outras tags HTML
            text = text.replace(/<[^>]*>/g, '');
            
            // Decodificar entidades HTML
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            text = textarea.value;
            
            // Limpar espa√ßos extras e quebras de linha
            text = text.replace(/\n\s*\n\s*\n/g, '\n\n'); // Max 2 quebras seguidas
            text = text.replace(/^\s+|\s+$/g, ''); // Remover espa√ßos in√≠cio/fim
            text = text.replace(/[ \t]+/g, ' '); // Normalizar espa√ßos
            
            return text;
        }

        // Configura√ß√µes EmailJS
        function loadEmailJSConfig() {
            const saved = localStorage.getItem('emailjsConfig');
            if (saved) {
                emailjsConfig = JSON.parse(saved);
                
                // Preencher campos
                document.getElementById('emailjsUserId').value = emailjsConfig.userId || '';
                document.getElementById('emailjsServiceId').value = emailjsConfig.serviceId || '';
                document.getElementById('emailjsTemplateId').value = emailjsConfig.templateId || '';
                document.getElementById('senderName').value = emailjsConfig.senderName || 'Mois√©s - Perito Grafot√©cnico';
                document.getElementById('monthlyLimit').value = emailjsConfig.monthlyLimit || 200;
                document.getElementById('geminiApiKey').value = emailjsConfig.geminiApiKey || '';
                
                // Verificar se est√° configurado
                if (emailjsConfig.userId && emailjsConfig.serviceId && emailjsConfig.templateId) {
                    emailjsConfig.isConfigured = true;
                    emailjs.init(emailjsConfig.userId);
                    document.getElementById('emailjsStatus').innerHTML = '‚úÖ Configurado';
                }
            }
            
            // Carregar templates salvos
            const savedTemplates = localStorage.getItem('templates');
            if (savedTemplates) {
                templates = JSON.parse(savedTemplates);
                updateTemplatesList();
                updateCampaignTemplateOptions();
            }
            
            updateEmailStatus();
        }

        function saveEmailJSConfig() {
            emailjsConfig.userId = document.getElementById('emailjsUserId').value;
            emailjsConfig.serviceId = document.getElementById('emailjsServiceId').value;
            emailjsConfig.templateId = document.getElementById('emailjsTemplateId').value;
            emailjsConfig.senderName = document.getElementById('senderName').value;
            emailjsConfig.monthlyLimit = parseInt(document.getElementById('monthlyLimit').value);
            emailjsConfig.geminiApiKey = document.getElementById('geminiApiKey').value;
            
            if (emailjsConfig.userId && emailjsConfig.serviceId && emailjsConfig.templateId) {
                emailjsConfig.isConfigured = true;
                emailjs.init(emailjsConfig.userId);
                document.getElementById('emailjsStatus').innerHTML = '‚úÖ Configurado';
                alert('‚úÖ Configura√ß√µes salvas com sucesso!\n\nüîß EmailJS e IA configurados e prontos para uso.');
            } else {
                emailjsConfig.isConfigured = false;
                document.getElementById('emailjsStatus').innerHTML = '‚ùå N√£o Configurado';
                alert('‚ùå Por favor, preencha todos os campos obrigat√≥rios do EmailJS.');
            }
            
            localStorage.setItem('emailjsConfig', JSON.stringify(emailjsConfig));
            updateEmailStatus();
        }

        function updateEmailStatus() {
            document.getElementById('emailsRemaining').textContent = emailjsConfig.monthlyLimit - emailjsConfig.sentThisMonth;
            document.getElementById('sentThisMonth').textContent = emailjsConfig.sentThisMonth;
        }

        // Teste do sistema de email
        async function testEmailSystem() {
            if (!emailjsConfig.isConfigured) {
                alert('‚ùå EmailJS n√£o configurado!\n\nüîß V√° para Configura√ß√µes e preencha suas credenciais do EmailJS primeiro.');
                showTab('settings');
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            
            try {
                await sendRealEmail(
                    'moises.peritografotecnico@gmail.com',
                    'üß™ Teste do Sistema - Mois√©s Perito',
                    '<p><strong>Ol√° Mois√©s!</strong></p><p>Este √© um email de teste do seu sistema de marketing.</p><p><strong>‚úÖ Sistema funcionando perfeitamente!</strong></p><p>Agora voc√™ pode enviar campanhas profissionais para seus clientes.</p><p><strong>Contato:</strong> moises.peritografotecnico@gmail.com</p>'
                );
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('lastTest').textContent = new Date().toLocaleString('pt-BR');
                alert('‚úÖ Email de teste enviado para moises.peritografotecnico@gmail.com!\n\nüîç IMPORTANTE: Verifique:\n‚Ä¢ Caixa de entrada\n‚Ä¢ Pasta SPAM/Lixo eletr√¥nico\n‚Ä¢ Pasta Promo√ß√µes\n\n‚è∞ Pode demorar 1-3 minutos para chegar.');
                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                alert('‚ùå Erro no teste: ' + error.message + '\n\nüîß POSS√çVEIS SOLU√á√ïES:\n‚Ä¢ Verifique se as chaves est√£o corretas\n‚Ä¢ Certifique-se que o template tem os campos: {{subject}}, {{message}}, {{to_email}}, {{from_name}}\n‚Ä¢ Aguarde alguns minutos e tente novamente');
            }
        }
        
        async function sendRealEmail(toEmail, subject, htmlContent) {
            if (!emailjsConfig.isConfigured) {
                throw new Error('EmailJS n√£o configurado');
            }
            
            if (emailjsConfig.sentThisMonth >= emailjsConfig.monthlyLimit) {
                throw new Error('Limite mensal de emails atingido');
            }
            
            try {
                // Converter HTML para texto limpo e formatado
                const cleanTextContent = htmlToCleanText(htmlContent);
                
                // M√∫ltiplas varia√ß√µes dos campos para m√°xima compatibilidade
                const templateParams = {
                    // Campos para destinat√°rio
                    to_email: toEmail,
                    to: toEmail,
                    email: toEmail,
                    recipient_email: toEmail,
                    user_email: toEmail,
                    
                    // Campos para remetente
                    from_name: emailjsConfig.senderName,
                    from: emailjsConfig.senderName,
                    sender_name: emailjsConfig.senderName,
                    name: emailjsConfig.senderName,
                    
                    // Campos para assunto
                    subject: subject,
                    title: subject,
                    email_subject: subject,
                    
                    // Campos para mensagem
                    message: cleanTextContent,
                    content: cleanTextContent,
                    body: cleanTextContent,
                    text: cleanTextContent,
                    email_message: cleanTextContent,
                    
                    // Campos extras que podem ser necess√°rios
                    reply_to: 'moises.peritografotecnico@gmail.com',
                    service_id: emailjsConfig.serviceId,
                    template_id: emailjsConfig.templateId
                };
                
                console.log('üìß ENVIANDO EMAIL REAL via EmailJS:');
                console.log('Para:', toEmail);
                console.log('Assunto:', subject);
                console.log('De:', emailjsConfig.senderName);
                console.log('Service ID:', emailjsConfig.serviceId);
                console.log('Template ID:', emailjsConfig.templateId);
                console.log('User ID:', emailjsConfig.userId);
                
                const response = await emailjs.send(
                    emailjsConfig.serviceId,
                    emailjsConfig.templateId,
                    templateParams
                );
                
                console.log('‚úÖ Email enviado com sucesso:', response);
                
                // Atualizar contador
                emailjsConfig.sentThisMonth++;
                localStorage.setItem('emailjsConfig', JSON.stringify(emailjsConfig));
                
                if (document.getElementById('sentThisMonth')) {
                    document.getElementById('sentThisMonth').textContent = emailjsConfig.sentThisMonth;
                }
                
                updateEmailStatus();
                return response;
                
            } catch (error) {
                console.error('‚ùå Erro detalhado ao enviar email:', error);
                console.error('Status:', error.status);
                console.error('Text:', error.text);
                
                // Mensagens de erro mais espec√≠ficas
                let errorMessage = 'Erro desconhecido';
                
                if (error.status === 400) {
                    errorMessage = 'Erro 400: Par√¢metros inv√°lidos. Verifique se o template tem os campos corretos.';
                } else if (error.status === 401) {
                    errorMessage = 'Erro 401: Chaves de autentica√ß√£o inv√°lidas. Verifique User ID, Service ID e Template ID.';
                } else if (error.status === 402) {
                    errorMessage = 'Erro 402: Limite de emails excedido ou conta suspensa.';
                } else if (error.status === 403) {
                    errorMessage = 'Erro 403: Acesso negado. Verifique se o dom√≠nio est√° autorizado.';
                } else if (error.status === 404) {
                    errorMessage = 'Erro 404: Service ID ou Template ID n√£o encontrado.';
                } else if (error.text) {
                    errorMessage = error.text;
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                throw new Error(errorMessage);
            }
        }

        // Gerenciamento de contatos
        function addContact() {
            const name = document.getElementById('contactName').value;
            const email = document.getElementById('contactEmail').value;
            const category = document.getElementById('contactCategory').value;
            
            if (!name || !email) {
                alert('‚ùå Por favor, preencha nome e email.');
                return;
            }
            
            // Validar email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('‚ùå Por favor, insira um email v√°lido.');
                return;
            }
            
            const newContact = {
                id: Date.now(),
                name: name,
                email: email,
                category: category
            };
            
            contacts.push(newContact);
            
            // Limpar campos
            document.getElementById('contactName').value = '';
            document.getElementById('contactEmail').value = '';
            
            updateContactList();
            updateDashboard();
            
            alert('‚úÖ Contato adicionado com sucesso!');
        }

        function removeContact(id) {
            if (confirm('‚ùì Tem certeza que deseja remover este contato?')) {
                contacts = contacts.filter(contact => contact.id !== id);
                updateContactList();
                updateDashboard();
            }
        }

        function updateContactList() {
            const contactList = document.getElementById('contactList');
            
            if (contacts.length === 0) {
                contactList.innerHTML = '<div class="contact-item"><div><strong>Nenhum contato cadastrado</strong><br><small>Adicione contatos para come√ßar suas campanhas</small></div></div>';
                return;
            }
            
            contactList.innerHTML = contacts.map(contact => `
                <div class="contact-item">
                    <div>
                        <strong>${contact.name}</strong><br>
                        <small>${contact.email} | ${contact.category}</small>
                    </div>
                    <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.9em;" onclick="removeContact(${contact.id})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function importContacts() {
            alert('üöß Funcionalidade em desenvolvimento!\n\nEm breve voc√™ poder√° importar contatos via:\n‚Ä¢ Arquivo CSV\n‚Ä¢ Planilha Excel\n‚Ä¢ Integra√ß√£o com Google Contacts');
        }

        // Campanhas
        function previewCampaign() {
            const templateId = document.getElementById('campaignTemplate').value;
            const templateElement = document.getElementById(templateId);
            
            if (templateElement) {
                const content = templateElement.innerHTML;
                const newWindow = window.open('', '_blank');
                newWindow.document.write(`
                    <html>
                        <head>
                            <title>Preview da Campanha</title>
                            <style>
                                body { font-family: Arial, sans-serif; padding: 20px; }
                                .preview-header { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                            </style>
                        </head>
                        <body>
                            <div class="preview-header">
                                <h2>üìß Preview da Campanha</h2>
                                <p><strong>Template:</strong> ${templateId === 'template1' ? 'Consultoria Gratuita' : 'Contrata√ß√£o Profissional'}</p>
                            </div>
                            ${content}
                        </body>
                    </html>
                `);
            }
        }

        async function sendCampaign() {
            const campaignName = document.getElementById('campaignName').value;
            const campaignMode = document.getElementById('campaignMode').value;
            const audience = document.getElementById('campaignAudience').value;
            const sendInterval = parseInt(document.getElementById('sendInterval').value);
            
            if (!campaignName) {
                alert('‚ùå Por favor, insira um nome para a campanha.');
                return;
            }
            
            if (!emailjsConfig.isConfigured) {
                alert('‚ùå EmailJS n√£o configurado!\n\nüîß V√° para Configura√ß√µes e configure suas credenciais primeiro.');
                showTab('settings');
                return;
            }
            
            // Obter templates selecionados
            let selectedTemplates = [];
            if (campaignMode === 'single') {
                const templateId = document.getElementById('campaignTemplate').value;
                selectedTemplates = [templateId];
            } else {
                const checkboxes = document.querySelectorAll('#templateCheckboxes input[type="checkbox"]:checked');
                selectedTemplates = Array.from(checkboxes).map(cb => cb.value);
            }
            
            if (selectedTemplates.length === 0) {
                alert('‚ùå Selecione pelo menos um template para a campanha.');
                return;
            }
            
            // Filtrar contatos por audi√™ncia
            let targetContacts = contacts;
            if (audience !== 'all') {
                targetContacts = contacts.filter(contact => contact.category === audience);
            }
            
            if (targetContacts.length === 0) {
                alert('‚ùå Nenhum contato encontrado para o p√∫blico-alvo selecionado.');
                return;
            }
            
            if (emailjsConfig.sentThisMonth + targetContacts.length > emailjsConfig.monthlyLimit) {
                alert(`‚ùå Limite mensal excedido!\n\nVoc√™ tem ${emailjsConfig.monthlyLimit - emailjsConfig.sentThisMonth} emails restantes este m√™s.\nEsta campanha enviaria ${targetContacts.length} emails.`);
                return;
            }
            
            const templateNames = selectedTemplates.map(id => {
                const template = templates.find(t => t.id === id);
                return template ? template.name : id;
            }).join(', ');
            
            let intervalText = '';
            if (sendInterval === 0) intervalText = 'Imediato';
            else if (sendInterval === 10080) intervalText = '1 semana';
            else if (sendInterval === 21600) intervalText = '15 dias';
            else if (sendInterval === 43200) intervalText = '1 m√™s';
            else intervalText = sendInterval + ' minutos';
            
            if (!confirm(`üì§ Confirmar envio da campanha?\n\nüìä Detalhes:\n‚Ä¢ Nome: ${campaignName}\n‚Ä¢ Modo: ${campaignMode === 'single' ? 'Template √önico' : 'Rota√ß√£o de Templates'}\n‚Ä¢ Templates: ${templateNames}\n‚Ä¢ Destinat√°rios: ${targetContacts.length} contatos\n‚Ä¢ P√∫blico: ${audience === 'all' ? 'Todos' : audience}\n‚Ä¢ Intervalo: ${intervalText}\n\n‚úÖ Continuar?`)) {
                return;
            }
            
            // Mostrar loading
            document.getElementById('campaignLoading').style.display = 'block';
            const progressBar = document.getElementById('campaignProgress');
            const statusElement = document.getElementById('campaignStatus');
            
            try {
                let successCount = 0;
                let errorCount = 0;
                
                // Enviar para cada contato
                for (let i = 0; i < targetContacts.length; i++) {
                    const contact = targetContacts[i];
                    
                    // Selecionar template (rota√ß√£o ou √∫nico)
                    const templateIndex = campaignMode === 'rotation' ? i % selectedTemplates.length : 0;
                    const templateId = selectedTemplates[templateIndex];
                    const template = templates.find(t => t.id === templateId);
                    
                    statusElement.textContent = `Enviando para ${contact.name} (${i + 1}/${targetContacts.length}) - Template: ${template.name}`;
                    
                    try {
                        // Obter conte√∫do do template
                        const templateElement = document.getElementById(templateId);
                        let templateContent = templateElement.innerHTML;
                        
                        // Para templates customizados, usar o conte√∫do salvo
                        if (!template.isDefault && template.content) {
                            templateContent = `<strong>Assunto:</strong> ${template.subject}<br><br><div style="background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); padding: 25px; border-radius: 12px; border: 2px solid #ffc107;">${formatTemplateContent(template.content)}<div style="text-align: center; margin: 25px 0;"><a href="https://firmeartepro.blogspot.com/p/sistema-de-consultoria-em-grafoscopia.html" target="_blank" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 25px; font-weight: bold; margin: 10px; display: inline-block;">ü§ñ AN√ÅLISE GRATUITA COM IA</a><br><a href="https://firmeartepro.blogspot.com/p/moises-firme-perito-assistente-tecnico.html" target="_blank" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 25px; font-weight: bold; margin: 10px; display: inline-block;">üìö SAIBA MAIS SOBRE MOIS√âS</a></div><p><strong>Contato:</strong> moises.peritografotecnico@gmail.com</p></div>`;
                        }
                        
                        // Extrair assunto do template
                        const subjectMatch = templateContent.match(/<strong>Assunto:<\/strong>\s*([^<]+)/);
                        const subject = subjectMatch ? subjectMatch[1].trim() : template.subject || 'Email do Mois√©s - Perito Grafot√©cnico';
                        
                        // Personalizar conte√∫do
                        let personalizedContent = templateContent.replace(/\[NOME\]/g, contact.name);
                        
                        await sendRealEmail(contact.email, subject, personalizedContent);
                        successCount++;
                        
                        // Atualizar progresso
                        const progress = ((i + 1) / targetContacts.length) * 100;
                        progressBar.style.width = progress + '%';
                        
                        // Delay entre envios
                        if (i < targetContacts.length - 1 && sendInterval > 0) {
                            let intervalText = '';
                            if (sendInterval === 10080) intervalText = '1 semana';
                            else if (sendInterval === 21600) intervalText = '15 dias';
                            else if (sendInterval === 43200) intervalText = '1 m√™s';
                            else intervalText = `${sendInterval} minutos`;
                            
                            statusElement.textContent = `Aguardando ${intervalText} para pr√≥ximo envio...`;
                            await new Promise(resolve => setTimeout(resolve, sendInterval * 60 * 1000));
                        } else if (i < targetContacts.length - 1) {
                            // Delay m√≠nimo para evitar spam
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                        
                    } catch (error) {
                        console.error(`Erro ao enviar para ${contact.email}:`, error);
                        errorCount++;
                    }
                }
                
                // Esconder loading
                document.getElementById('campaignLoading').style.display = 'none';
                
                // Salvar campanha
                const campaign = {
                    id: Date.now(),
                    name: campaignName,
                    mode: campaignMode,
                    templates: selectedTemplates,
                    audience: audience,
                    sent: successCount,
                    errors: errorCount,
                    interval: sendInterval,
                    date: new Date().toLocaleString('pt-BR')
                };
                
                campaigns.push(campaign);
                updateDashboard();
                
                alert(`‚úÖ Campanha enviada!\n\nüìä Resultados:\n‚Ä¢ Enviados com sucesso: ${successCount}\n‚Ä¢ Erros: ${errorCount}\n‚Ä¢ Total de destinat√°rios: ${targetContacts.length}\n‚Ä¢ Templates usados: ${selectedTemplates.length}\n\nüìß Os emails podem demorar alguns minutos para chegar.`);
                
            } catch (error) {
                document.getElementById('campaignLoading').style.display = 'none';
                alert('‚ùå Erro ao enviar campanha: ' + error.message);
            }
        }

        function scheduleCampaign() {
            alert('üöß Funcionalidade em desenvolvimento!\n\nEm breve voc√™ poder√° agendar campanhas para:\n‚Ä¢ Data e hora espec√≠ficas\n‚Ä¢ Envios recorrentes\n‚Ä¢ Automa√ß√£o baseada em eventos');
        }

        // Gerenciamento de Templates
        function toggleCampaignMode() {
            const mode = document.getElementById('campaignMode').value;
            const singleGroup = document.getElementById('singleTemplateGroup');
            const rotationGroup = document.getElementById('rotationTemplateGroup');
            
            if (mode === 'single') {
                singleGroup.style.display = 'block';
                rotationGroup.style.display = 'none';
            } else {
                singleGroup.style.display = 'none';
                rotationGroup.style.display = 'block';
            }
        }
        
        function createNewTemplate() {
            const templateName = prompt('üìù Nome do Template:', 'Novo Template');
            if (!templateName) return;
            
            const templateSubject = prompt('üìß Assunto do Email:', 'Assunto do Email');
            if (!templateSubject) return;
            
            const templateContent = prompt('‚úçÔ∏è Conte√∫do do Template (use [NOME] para personalizar):', 
                'Ol√° [NOME],\n\nEste √© um novo template criado por voc√™!\n\nAtenciosamente,\nMois√©s - Perito Grafot√©cnico');
            if (!templateContent) return;
            
            const templateId = 'template_' + Date.now();
            const newTemplate = {
                id: templateId,
                name: templateName,
                subject: templateSubject,
                content: templateContent,
                isDefault: false
            };
            
            templates.push(newTemplate);
            localStorage.setItem('templates', JSON.stringify(templates));
            
            addTemplateToDOM(newTemplate);
            updateCampaignTemplateOptions();
            updateDashboard();
            
            alert('‚úÖ Template criado com sucesso!');
        }
        
        function addTemplateToDOM(template) {
            const templatesList = document.getElementById('templatesList');
            const templateHTML = `
                <div class="email-template" data-template-id="${template.id}">
                    <h3>üìù Template: ${template.name}</h3>
                    <div class="template-preview" id="${template.id}">
                        <strong>Assunto:</strong> ${template.subject}
                        <br><br>
                        <div style="background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); padding: 25px; border-radius: 12px; border: 2px solid #ffc107;">
                            ${formatTemplateContent(template.content)}
                            <div style="text-align: center; margin: 25px 0;">
                                <a href="https://firmeartepro.blogspot.com/p/sistema-de-consultoria-em-grafoscopia.html" target="_blank" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 25px; font-weight: bold; margin: 10px; display: inline-block;">
                                    ü§ñ AN√ÅLISE GRATUITA COM IA
                                </a>
                                <br>
                                <a href="https://firmeartepro.blogspot.com/p/moises-firme-perito-assistente-tecnico.html" target="_blank" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 25px; font-weight: bold; margin: 10px; display: inline-block;">
                                    üìö SAIBA MAIS SOBRE MOIS√âS
                                </a>
                            </div>
                            <p><strong>Contato:</strong> moises.peritografotecnico@gmail.com</p>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="deleteTemplate('${template.id}')" style="margin-top: 10px;">üóëÔ∏è Excluir</button>
                </div>
            `;
            templatesList.insertAdjacentHTML('beforeend', templateHTML);
        }
        
        function formatTemplateContent(content) {
            return content.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }
        
        function deleteTemplate(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (template && template.isDefault) {
                alert('‚ùå N√£o √© poss√≠vel excluir templates padr√£o do sistema.');
                return;
            }
            
            if (confirm('‚ùì Tem certeza que deseja excluir este template?')) {
                templates = templates.filter(t => t.id !== templateId);
                localStorage.setItem('templates', JSON.stringify(templates));
                
                document.querySelector(`[data-template-id="${templateId}"]`).remove();
                updateCampaignTemplateOptions();
                updateDashboard();
                
                alert('‚úÖ Template exclu√≠do com sucesso!');
            }
        }
        
        function updateTemplatesList() {
            const templatesList = document.getElementById('templatesList');
            templatesList.innerHTML = '';
            
            templates.forEach(template => {
                if (template.isDefault) {
                    // Templates padr√£o j√° est√£o no HTML
                    return;
                }
                addTemplateToDOM(template);
            });
        }
        
        function updateCampaignTemplateOptions() {
            const singleSelect = document.getElementById('campaignTemplate');
            const checkboxContainer = document.getElementById('templateCheckboxes');
            
            // Atualizar select √∫nico
            singleSelect.innerHTML = '';
            templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = `üìù ${template.name}`;
                singleSelect.appendChild(option);
            });
            
            // Atualizar checkboxes de rota√ß√£o
            checkboxContainer.innerHTML = '';
            templates.forEach(template => {
                const label = document.createElement('label');
                label.style.display = 'block';
                label.style.marginBottom = '10px';
                label.innerHTML = `
                    <input type="checkbox" value="${template.id}" checked> üìù ${template.name}
                `;
                checkboxContainer.appendChild(label);
            });
        }
        
        async function generateAITemplate() {
            if (!emailjsConfig.geminiApiKey) {
                alert('‚ùå Configure sua chave da API do Gemini primeiro!\n\nüîß V√° para Configura√ß√µes e adicione sua API Key.');
                showTab('settings');
                return;
            }
            
            const templateType = prompt(`ü§ñ GERADOR DE TEMPLATES COM IA
            
Escolha o tipo de template:

1 - Promo√ß√£o/Oferta Especial
2 - Apresenta√ß√£o Profissional  
3 - Urg√™ncia/Emerg√™ncia
4 - Educativo/Informativo
5 - Depoimento/Testemunhal
6 - Follow-up/Acompanhamento
7 - Convite para Evento
8 - Newsletter Informativa

Digite o n√∫mero (1-8):`);
            
            if (!templateType || templateType < 1 || templateType > 8) {
                alert('‚ùå Op√ß√£o inv√°lida. Tente novamente.');
                return;
            }
            
            const customMessage = prompt('üìù Personalize seu template:\n\nDigite uma mensagem espec√≠fica ou contexto adicional (opcional):');
            
            document.getElementById('loading').style.display = 'block';
            
            try {
                const generatedTemplate = await callGeminiAPI(templateType, customMessage);
                
                const templateId = 'ai_template_' + Date.now();
                const newTemplate = {
                    id: templateId,
                    name: generatedTemplate.name,
                    subject: generatedTemplate.subject,
                    content: generatedTemplate.content,
                    isDefault: false
                };
                
                templates.push(newTemplate);
                localStorage.setItem('templates', JSON.stringify(templates));
                
                addTemplateToDOM(newTemplate);
                updateCampaignTemplateOptions();
                updateDashboard();
                
                document.getElementById('loading').style.display = 'none';
                alert('‚úÖ Template gerado com IA com sucesso!\n\nüé® Novo template criado e adicionado ao sistema.');
                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                alert('‚ùå Erro ao gerar template com IA: ' + error.message);
            }
        }
        
        async function callGeminiAPI(templateType, customMessage) {
            const typeDescriptions = {
                1: 'promo√ß√£o com oferta especial e desconto',
                2: 'apresenta√ß√£o profissional e credibilidade',
                3: 'urg√™ncia e atendimento emergencial',
                4: 'educativo sobre grafoscopia',
                5: 'depoimento de cliente satisfeito',
                6: 'follow-up p√≥s-atendimento',
                7: 'convite para evento ou webinar',
                8: 'newsletter com dicas e novidades'
            };
            
            // Validar API Key
            const apiKey = emailjsConfig.geminiApiKey.trim();
            if (!apiKey.startsWith('AIza')) {
                throw new Error('API Key inv√°lida. Deve come√ßar com "AIza"');
            }
            
            const prompt = `Crie um template de email marketing profissional para Mois√©s, um perito grafot√©cnico especializado em an√°lise de documentos.

Tipo de template: ${typeDescriptions[templateType]}
Contexto adicional: ${customMessage || 'Nenhum'}

Requisitos:
- Use [NOME] para personaliza√ß√£o
- Tom profissional mas acess√≠vel
- Foque em grafoscopia e an√°lise de documentos
- Inclua elementos de urg√™ncia ou valor quando apropriado
- M√°ximo 200 palavras no conte√∫do
- Use emojis moderadamente

Retorne APENAS um JSON v√°lido com esta estrutura:
{
  "name": "Nome do Template",
  "subject": "Assunto do Email",
  "content": "Conte√∫do do email em HTML simples"
}`;

            // URLs para testar (Google mudou recentemente)
            const apiUrls = [
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`,
                `https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=${apiKey}`
            ];

            let lastError = null;
            
            // Tentar cada URL at√© uma funcionar
            for (let i = 0; i < apiUrls.length; i++) {
                try {
                    console.log(`ü§ñ Tentando API URL ${i + 1}:`, apiUrls[i].split('?')[0]);
                    
                    const response = await fetch(apiUrls[i], {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 1000
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`‚ùå Erro ${response.status}:`, errorText);
                        
                        if (response.status === 400) {
                            throw new Error('API Key inv√°lida ou modelo n√£o encontrado');
                        } else if (response.status === 403) {
                            throw new Error('API Key sem permiss√£o ou regi√£o bloqueada');
                        } else if (response.status === 429) {
                            throw new Error('Limite de requisi√ß√µes excedido. Tente novamente em alguns minutos');
                        } else {
                            throw new Error(`Erro ${response.status}: ${errorText}`);
                        }
                    }
                    
                    const data = await response.json();
                    
                    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                        throw new Error('Resposta da API inv√°lida');
                    }
                    
                    const generatedText = data.candidates[0].content.parts[0].text;
                    console.log('‚úÖ Resposta da IA:', generatedText);
                    
                    // Extrair JSON da resposta
                    const jsonMatch = generatedText.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('Resposta da IA n√£o cont√©m JSON v√°lido');
                    }
                    
                    return JSON.parse(jsonMatch[0]);
                    
                } catch (error) {
                    console.error(`‚ùå Erro na URL ${i + 1}:`, error.message);
                    lastError = error;
                    
                    // Se n√£o √© erro de rede, n√£o tentar outras URLs
                    if (error.message.includes('API Key') || error.message.includes('permiss√£o')) {
                        throw error;
                    }
                }
            }
            
            // Se chegou aqui, todas as URLs falharam
            throw new Error(`Todas as URLs da API falharam. √öltimo erro: ${lastError.message}`);
        }
        
        async function testGeminiAPI() {
            if (!emailjsConfig.geminiApiKey) {
                alert('‚ùå Configure sua chave da API do Gemini primeiro!');
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            
            try {
                // Validar formato da API Key
                const apiKey = emailjsConfig.geminiApiKey.trim();
                if (!apiKey.startsWith('AIza')) {
                    throw new Error('API Key inv√°lida. Deve come√ßar com "AIza"');
                }
                
                // URLs para testar (vers√µes mais recentes)
                const testUrls = [
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`,
                    `https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=${apiKey}`
                ];
                
                let success = false;
                let lastError = null;
                
                for (let i = 0; i < testUrls.length; i++) {
                    try {
                        console.log(`üß™ Testando URL ${i + 1}:`, testUrls[i].split('?')[0]);
                        
                        const response = await fetch(testUrls[i], {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: 'Responda apenas: "IA funcionando perfeitamente!"'
                                    }]
                                }],
                                generationConfig: {
                                    temperature: 0.1,
                                    maxOutputTokens: 50
                                }
                            })
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`‚ùå Erro ${response.status}:`, errorText);
                            
                            let errorMsg = '';
                            if (response.status === 400) {
                                errorMsg = 'API Key inv√°lida ou modelo n√£o dispon√≠vel';
                            } else if (response.status === 403) {
                                errorMsg = 'API Key sem permiss√£o. Verifique se a API est√° habilitada';
                            } else if (response.status === 429) {
                                errorMsg = 'Muitas requisi√ß√µes. Aguarde alguns minutos';
                            } else {
                                errorMsg = `Erro ${response.status}: ${errorText}`;
                            }
                            
                            throw new Error(errorMsg);
                        }
                        
                        const data = await response.json();
                        
                        if (!data.candidates || !data.candidates[0]) {
                            throw new Error('Resposta da API inv√°lida');
                        }
                        
                        const result = data.candidates[0].content.parts[0].text;
                        
                        document.getElementById('loading').style.display = 'none';
                        alert(`‚úÖ IA testada com sucesso!\n\nü§ñ Resposta: ${result}\nüîó URL funcionando: ${i + 1}/${testUrls.length}\n\nüéâ Sistema pronto para gerar templates!`);
                        success = true;
                        break;
                        
                    } catch (error) {
                        console.error(`‚ùå Falha na URL ${i + 1}:`, error.message);
                        lastError = error;
                        
                        // Se √© erro de autentica√ß√£o, n√£o tentar outras URLs
                        if (error.message.includes('API Key') || error.message.includes('permiss√£o')) {
                            break;
                        }
                    }
                }
                
                if (!success) {
                    document.getElementById('loading').style.display = 'none';
                    alert(`‚ùå Erro no teste da IA: ${lastError.message}\n\nüîß SOLU√á√ïES:\n\n1. Verifique se a API Key est√° correta\n2. Acesse: https://makersuite.google.com/app/apikey\n3. Gere uma nova API Key\n4. Aguarde 5-10 minutos ap√≥s gerar\n5. Certifique-se que a API Gemini est√° habilitada`);
                }
                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                alert(`‚ùå Erro no teste da IA: ${error.message}\n\nüîß Verifique:\n‚Ä¢ API Key deve come√ßar com "AIza"\n‚Ä¢ Deve ter cerca de 39 caracteres\n‚Ä¢ Sem espa√ßos extras\n‚Ä¢ API habilitada no Google Cloud`);
            }
        }

        // Dashboard
        function updateDashboard() {
            document.getElementById('totalContacts').textContent = contacts.length;
            document.getElementById('sentThisMonth').textContent = emailjsConfig.sentThisMonth;
            document.getElementById('campaignsCount').textContent = campaigns.length;
            document.getElementById('templatesCount').textContent = templates.length;
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'973e3a7ff5d6ca97',t:'MTc1NTk5MDA1Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>











